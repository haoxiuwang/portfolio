---
title: 'Rewrite ExpressJs'
subtitle: 'Prism with Next.js subtitle'
date: '2020/01/11'
description: 'These codes simulate the inner workings of <u>ExpressJS</u> simply ...'
image: '/assets/images/expressjs.png'
tags:
  - "expressjs"
  - "web framework"
  - "nodejs"
  - "asynchronous"
github: "github"
demo: "github"
---
Expressjs is most popular nodejs application web framework. But for beginers, It's very hard to understand. My "expressjs" shows the core logic of Expressjs, with only 40 rows of codes explaining how express to work.
```nodejs
//source codes
var app = function(req, res, next) {
    app.handle(req, res, next);
    res.app = req.app = app;
    res.redirect = app.redirect;
}

app.routers = {};
app.middlewares = new Array();
app.use = function(url, method, handler) {
    if (handler) {
        app.route(url, method, handler);
    } else
        app.middlewares.push(url);
}
app.route = function(url, method, handler) {
    if (!app.routers[url + method])
        app.routers[url + method] = new Array();
    var router = app.routers[url + method];
    router.push(handler);
}
app.handle = function(req, res, next) {
    iterate(app.middlewares, req, res, function() {
        var router = app.routers[req.url + req.method];
        if (router)
            iterate(router, req, res, next);
        else if (next)
            next(req, res);
    });
    function iterate(middlewares, req, res, next) {
        var i = 0;
        function nextMid() {
            if (i < middlewares.length)
                middlewares[i++](req, res, nextMid);
            else if (next)
                next(req, res);
        }
        nextMid();
    }
}
app.redirect = function(){}
module.exports = app;
```
Essentially, Expressjs is just used as the nodejs server's handler, which works like a pipeline of factory, with `use` function adding workshops to pipeline, and `route` function. The following is a example that apply my "expressjs" to build a web server.
```nodejs
const http = require('http');
const app = require('./mycode')
const middlewares1 = require('middlewares1');
const middlewares2 = require('middlewares2');
app.use(middlewares1)
app.use(middlewares2)
... //add more workshops to pipeline
app.route('/',"GET",handler1)
app.route('/about',"GET",handler2)
app.route('/blogs',"GET",handler2)
...//at last step of pipeline, branch requests to different handlers
http.createServer(app).listen(80)
```
